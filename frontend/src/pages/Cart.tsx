import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";



interface CartItem {
    id: number;
    itemId: number; 
    itemQuantity: number;
    itemName: string;   
    itemPrice: number;    
}

function Cart() {
    const [cartItems, setCartItems] = useState([]);
    const [isCartModified, setIsCartModified] = useState(false);
    const navigate = useNavigate();

    useEffect(() => {
        getCartItems();
    }, [isCartModified]);

    const getCartItems = async () => {
        try{ 
            const token = localStorage.getItem('token')??'string';
            const response = await fetch(`http://127.0.0.1:5182/getUserItems`, {
                method: 'GET', 
                headers: {
                'Authorization':  `${token}`,
              }});
            if (response.ok) {
                const data = await response.json();
                const sortedData = data.sort((a, b) => {
                  if (a.itemName < b.itemName) {
                    return -1;
                  }
                });
                setCartItems(sortedData);
            }      
        } catch (error) {
            console.log(error);
        }
    }

    const updateCartItem = async (item: CartItem, Quantity: number) => {
      try{ 
          item.itemQuantity = Quantity;
          const token = localStorage.getItem('token')??'string';
          const response = await fetch(`http://127.0.0.1:5182/updateCartItem`, {
              method: 'PUT', 
              headers: {
                'content-type': 'application/json',
                'Authorization':  `${token}`,
              },
              body:  JSON.stringify(item)
          });
          if (response.ok) {
              setIsCartModified(!isCartModified);
          }      
      } catch (error) {
          console.log(error);
      }
    }

    const removeCartItem = async (itemId: number) => {
      try{   
          const token = localStorage.getItem('token')??'string';
          const response = await fetch(`http://127.0.0.1:5182/removeCartItem/${itemId}`, {
              method: 'DELETE', 
              headers: {
                'Authorization':  `${token}`,
              },
          });
          if (response.ok) {
              setIsCartModified(!isCartModified);
          }      
      } catch (error) {
          console.log(error);
      }
    }

    const clearCart = async () => {
      try{   
          const token = localStorage.getItem('token')??'string';
          const response = await fetch(`http://127.0.0.1:5182/clearUserCart/`, {
              method: 'DELETE', 
              headers: {
                'Authorization':  `${token}`,
              },
          });
          if (response.ok) {
              navigate('/');
          }      
      } catch (error) {
          console.log(error);
      }
    }
          
    return (    
      <div className="mt-2 flex flex-col">
        <div className="-my-2 overflow-x-auto -mx-4 sm:-mx-6 lg:-mx-8">
          <div className="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
            <div className="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Remove One</th>
                    <th>Add one</th>
                    <th>Delete from cart</th>
                  </tr>
                </thead>
                <tbody>
                  {cartItems.map((item, i) => (
                    <tr key={item.itemId}>
                      <td>{item.itemName}</td>
                      <td>{item.itemPrice}</td>
                      <td>{item.itemQuantity}</td>
                      <td><button onClick={() => {updateCartItem(item, (item.itemQuantity - 1))}}>-</button></td>
                      <td><button onClick={() => {updateCartItem(item, (item.itemQuantity + 1))}}>+</button></td>
                      <td><button onClick={() => {removeCartItem(item.id)}}>x</button></td>
                    </tr>
                  ))}  
                </tbody>           
              </table>    
            </div>
            <button onClick={() => {clearCart()}}>Clear Cart</button>
          </div>
        </div>
      </div>
    );
}

export default Cart;