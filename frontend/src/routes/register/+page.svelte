<script lang="ts">
	import Fa from 'svelte-fa/src/fa.svelte';
	import { faFileSignature, faTriangleExclamation } from '@fortawesome/free-solid-svg-icons';
	import { goto } from '$app/navigation';
	import { toastStore, type ToastSettings } from '@skeletonlabs/skeleton';

	interface registerInput {
		username: string;
		email: string;
		firstName: string;
		lastName: string;
		address: string;
		phoneNumber: string;
		password: string;
		passwordConfirm: string;
	}

	let input: registerInput = {
		username: '',
		email: '',
		firstName: '',
		lastName: '',
		address: '',
		phoneNumber: '',
		password: '',
		passwordConfirm: ''
	};
	let error = '';

	async function handleSubmit() {
		try {
			if (input.password === input.passwordConfirm) {
				try {
					const response = await fetch('http://127.0.0.1:5180/register', { method: 'POST', body: JSON.stringify(input) });
					const responseText = await response.text();

					if (response.status !== 200) {
						error = responseText;
					} else {
						const t: ToastSettings = {
							message: responseText,
							background: 'variant-filled-success'
						};
						toastStore.trigger(t);
						goto('/login');
					}
				} catch (error) {
					error = 'We are currently experiencing technical difficulties, please try again later';
				}
			} else {
				error = 'Your passwords do not match.';
			}
		} catch (e) {
			error = 'We are experiencing technical difficulties, please try again later.';
		}
	}
</script>

{#if error.length > 0}
	<aside class="alert variant-filled-error">
		<div><Fa icon={faTriangleExclamation} class="inline" size="1.5x" /></div>
		<div class="alert-message">
			<p>{error}</p>
		</div>
	</aside>
{/if}

<div class="card p-4">
	<h2 class="font-bold">Register</h2>
	<form method="POST" on:submit|preventDefault={handleSubmit}>
		<input class="input" type="text" name="username" placeholder="Username" bind:value={input.username} required />
		<input class="input" type="text" name="email" placeholder="Email" bind:value={input.email} required />
		<input class="input" type="text" name="firstName" placeholder="First Name" bind:value={input.firstName} required />
		<input class="input" type="text" name="lastName" placeholder="Last Name" bind:value={input.lastName} required />
		<input class="input" type="text" name="address" placeholder="Address" bind:value={input.address} />
		<input class="input" type="text" name="phoneNumber" placeholder="Phone Number" bind:value={input.phoneNumber} />
		<input class="input" type="password" name="password" placeholder="Password" bind:value={input.password} required />
		<input class="input" type="password" name="passwordConfirm" placeholder="Re-enter your password" bind:value={input.passwordConfirm} required />
		<button type="submit" class="btn variant-filled">
			<span><Fa icon={faFileSignature} /></span>
			<span>Register</span>
		</button>
	</form>

	<hr class="my-4 m-auto w-3/4 h-px border-t-0 bg-surface-500 opacity-100" />

	<a href="/login">Login</a>
</div>

<style>
	.card,
	.alert {
		max-width: 40%;
		text-align: center;
		margin: auto;
	}

	.alert {
		margin-bottom: 2%;
		text-align: left;
	}

	input,
	button {
		margin-top: 2%;
	}
</style>
