<script lang="ts">
	import { goto } from '$app/navigation';
	import { page } from '$app/stores';
	import { cartUpdate, storeToken, storeUsername } from '$lib/stores';
	import { faCartPlus, faComment, faFileImage } from '@fortawesome/free-solid-svg-icons';
	import { toastStore, type ToastSettings, FileDropzone } from '@skeletonlabs/skeleton';
	import { onMount } from 'svelte';
	import Fa from 'svelte-fa/src/fa.svelte';
	import { get } from 'svelte/store';

	interface Product {
		id: number;
		name: string;
		price: number;
		stock: number;
		image: string;
		description: string;
	}

	interface Review {
		id: number;
		productId: number;
		customerId: number;
		reviewText: string;
		title: string;
		imageUrl?: string;
		timeCreated: string;
		timeUpdated: string;
	}

	interface CartItem {
		itemQuantity: number;
		itemId: number;
	}

	interface ReviewForm {
		itemId: number;
		title: string;
		reviewText: string;
		image: File | null;
	}

	const itemId = $page.params.id;
	let item: Product | null = null;
	let reviews: Review[] = [];

	let reviewInput: ReviewForm = {
		itemId: parseInt(itemId),
		title: '',
		reviewText: '',
		image: null
	};

	async function getItem() {
		try {
			const response = await fetch(`http://localhost:5181/getItem/${itemId}`);
			if (response.status == 200) {
				const data = await response.json();
				item = data;
			}
		} catch (error) {
			goto('/');
			console.log(error);
		}
	}

	async function addToCart(id: number) {
		if (get(storeUsername) === null) {
			const t: ToastSettings = {
				message: 'You need to be signed in to add an item to your cart.',
				background: 'variant-filled-tertiary'
			};
			toastStore.trigger(t);
		} else {
			try {
				const cartItem: CartItem = { itemId: id, itemQuantity: 1 };
				const token = get(storeToken);
				await fetch(`http://127.0.0.1:5182/addCartItem`, {
					method: 'POST',
					headers: {
						'content-type': 'application/json',
						Authorization: `${token}`
					},
					body: JSON.stringify(cartItem)
				});
				cartUpdate.update((value) => !value);

				const t: ToastSettings = {
					message: 'Item added to cart.',
					background: 'variant-filled-success'
				};
				toastStore.trigger(t);
			} catch (error) {
				console.log(error);
			}
		}
	}

	async function getReviewPictures(reviewId: number) {
		try {
			const response = await fetch(`http://localhost:5183/getPictures/${reviewId}`, {
				headers: {
					Authorization: `${get(storeToken)}`
				}
			});

			if (response.status === 200) {
				const data = await response.json();
				return data;
			}
		} catch (error) {
			console.log(error);
		}
		return [];
	}

	async function getReviews() {
		try {
			const response = await fetch(`http://localhost:5183/getReviewsForItem/${itemId}`, {
				headers: {
					Authorization: `${get(storeToken)}`
				}
			});

			if (response.status == 200) {
				const data = await response.json();
				const reviewWithPictures = await Promise.all(
					data.map(async (review: Review) => {
						const pictures = await getReviewPictures(review.id);
						if (pictures.length > 0) {
							review.imageUrl = `http://localhost:5183/getPicture/${pictures[0].id}`;
						}
						return review;
					})
				);
				reviews = reviewWithPictures;
			}
		} catch (error) {
			console.log(error);
		}
	}

	function onImageUploadHandler(e: Event): void {
		if (event.target.files) {
			reviewInput.image = event.target?.files[0];
		}
	}

	async function addReview() {
		try {
			const response = await fetch(`http://localhost:5183/postReview`, {
				method: 'POST',
				body: JSON.stringify({
					itemId: reviewInput.itemId,
					title: reviewInput.title,
					reviewText: reviewInput.reviewText
				}),
				headers: {
					'Content-Type': 'application/json',
					Authorization: `${get(storeToken)}`
				}
			});

			if (response.status == 200) {
				const reviewId = await response.json();

				if (reviewInput.image) {
					const formData = new FormData();
					formData.append('picture', reviewInput.image);

					const imgResponse = await fetch(`http://localhost:5183/postPicture/${reviewId}`, {
						method: 'POST',
						body: formData,
						headers: {
							Authorization: `${get(storeToken)}`
						}
					});

					if (imgResponse.status !== 200) {
						console.log('Error uploading image');
					}
				}

				reviewInput = {
					itemId: parseInt(itemId),
					title: '',
					reviewText: '',
					image: null
				};

				getReviews();
			} else {
				console.log('Error adding review');
			}
		} catch (error) {
			console.log(error);
		}
	}

	onMount(async () => {
		getItem();
		getReviews();
	});
</script>

<div class="card">
	<div class="card-header">
		<h2 class="font-bold mb-2">{item?.name}</h2>
		<img class="object-scale-down w-[200px] h-[150px] mx-auto" src={item?.image} alt={item?.name} />
	</div>
	<div class="p-4">
		<h3 class="font-bold text-error-600">${item?.price}</h3>
		<p>In stock: <span class="font-bold">{item?.stock}</span></p>
		<p class="mt-2">{item?.description}</p>
	</div>
	<div class="card-footer">
		<button type="button" class="btn variant-filled" on:click={addToCart(item?.id)}>
			<span><Fa icon={faCartPlus} /></span>
			<span>Add to cart</span>
		</button>
	</div>
</div>

{#if get(storeUsername) !== null}
	<div class="card">
		<div class="p-4 mt-5">
			<h2 class="font-bold mb-3">Review product</h2>
			<form on:submit|preventDefault={addReview}>
				<input
					class="input mt-2"
					type="text"
					placeholder="Review title"
					bind:value={reviewInput.title}
					required
				/>
				<textarea
					class="textarea mt-2"
					rows="4"
					placeholder="Description"
					bind:value={reviewInput.reviewText}
					required
				/>

				<FileDropzone accept="image/*" name="files" on:change={onImageUploadHandler}>
					<svelte:fragment slot="lead">
						<Fa class="inline" icon={faFileImage} size="2.5x" />
					</svelte:fragment>
					<svelte:fragment slot="message">Upload a file or drag and drop</svelte:fragment>
					<svelte:fragment slot="meta">Only images are allowed</svelte:fragment>
				</FileDropzone>

				<button type="submit" class="btn variant-filled mt-2">
					<span><Fa icon={faComment} /></span>
					<span>Review</span>
				</button>
			</form>
		</div>
	</div>
{/if}

{#if reviews.length > 0}
	{#each reviews as review}
		<div class="card">
			<div class="card-header mt-5">
				<h3>{review.title}</h3>
				<div class="p-4 review">
					<p>
						<span class="font-bold">Review Date:</span>
						{new Date(review.timeCreated).toLocaleString()}
					</p>
					<p><span class="font-bold">Description</span> {review.reviewText}</p>
				</div>
			</div>
			<div class="card-footer">
				{#if review.imageUrl !== undefined}
					<img src={review.imageUrl} alt="Review {review.title}" />
				{/if}
			</div>
		</div>
	{/each}
{/if}

<style>
	.card {
		width: 60%;
		margin: auto;
		text-align: center;
	}

	.review {
		text-align: left;
	}
</style>
