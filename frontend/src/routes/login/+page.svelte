<script lang="ts">
	import Fa from 'svelte-fa/src/fa.svelte';
	import { faKey, faTriangleExclamation } from '@fortawesome/free-solid-svg-icons';
	import { goto } from '$app/navigation';
	import { storeToken, storeUsername } from '$lib/stores';
	import { toastStore, type ToastSettings } from '@skeletonlabs/skeleton';

	let username = '';
	let password = '';
	let error = '';

	async function handleSubmit() {
		try {
			const response = await fetch('http://127.0.0.1:5180/login', {
				method: 'POST',
				body: JSON.stringify({ username: username, password: password })
			});
			if (!response.ok) {
				const responseText = await response.text();
				error = responseText;
			} else {
				const responseJson = await response.json();
				storeUsername.set(responseJson.username);
				storeToken.set(responseJson.token);

				const t: ToastSettings = {
					message: 'Signed in successfully.',
					background: 'variant-filled-success'
				};
				toastStore.trigger(t);
				goto('/');
			}
		} catch (e) {
			error = 'We are experiencing technical difficulties, please try again later.';
		}
	}

	if ($storeUsername !== null) {
		goto('/');
	}
</script>

{#if error.length > 0}
	<aside class="alert variant-filled-error">
		<div><Fa icon={faTriangleExclamation} size="1.5x" /></div>
		<div class="alert-message">
			<p>{error}</p>
		</div>
	</aside>
{/if}

<div class="card p-4">
	<h2 class="font-bold">Login</h2>
	<form method="POST" on:submit|preventDefault={handleSubmit}>
		<input class="input" type="text" name="username" placeholder="Username" bind:value={username} required />
		<input class="input" type="password" name="password" placeholder="Password" bind:value={password} required />
		<button type="submit" class="btn variant-filled">
			<span><Fa icon={faKey} /></span>
			<span>Login</span>
		</button>
	</form>

	<hr class="my-4 mx-auto h-px w-3/4" />

	<a href="/register">Create a new account</a>
</div>

<style>
	.card,
	.alert {
		max-width: 40%;
		text-align: center;
		margin: auto;
	}

	.alert {
		margin-bottom: 2%;
		text-align: left;
	}

	input,
	button {
		margin-top: 2%;
	}
</style>
