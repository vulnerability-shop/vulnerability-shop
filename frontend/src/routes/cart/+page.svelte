<script lang="ts">
	import { cartUpdate, storeToken } from '$lib/stores';
	import Fa from 'svelte-fa/src/fa.svelte';
	import { faTrash, faPlus, faMinus, faStore } from '@fortawesome/free-solid-svg-icons';
	import { get } from 'svelte/store';
	import { onMount } from 'svelte';
	import { toastStore, type ToastSettings } from '@skeletonlabs/skeleton';
	import { goto } from '$app/navigation';
	import jwt_decode from 'jwt-decode';

	interface CartItem {
		id: number;
		itemId: number;
		itemQuantity: number;
		itemName: string;
		itemPrice: number;
	}

	interface JwtClaims {
		userId: number;
		iat: number;
		exp: number;
	}

	function getUserIdFromToken(token: string): number {
		try {
			const decoded: JwtClaims = jwt_decode(token);
			return decoded.userId;
		} catch (error) {
			console.error('Error decoding token:', error);
			return -1;
		}
	}

	let cartItems: CartItem[] = [];
	let total = 0;

	async function order() {
		try {
			const token = get(storeToken);
			const response = await fetch(`http://127.0.0.1:5184/addPurchase`, {
				method: 'POST',
				body: JSON.stringify({
					CustomerId: getUserIdFromToken(get(storeToken) ?? '').toString(),
					PaymentId: 1,
					Items: cartItems
				}),
				headers: {
					Authorization: `${token}`
				}
			});
			if (response.ok) {
				const data = await response.json();

				const t: ToastSettings = {
					message: 'Purchase completed!',
					background: 'variant-filled-success'
				};

				toastStore.trigger(t);

				cartUpdate.update((value) => !value);
				cartItems = [];

				goto('/');
			}
		} catch (error) {
			console.log(error);
		}
	}

	async function loadCartItems() {
		try {
			const token = get(storeToken);
			const response = await fetch(`http://127.0.0.1:5182/getUserItems`, {
				method: 'GET',
				headers: {
					Authorization: `${token}`
				}
			});
			if (response.ok) {
				const data = await response.json();
				const sortedData = data.sort((a, b) => {
					if (a.itemName < b.itemName) {
						return -1;
					}
				});
				cartItems = sortedData;
				getTotal();
			}
		} catch (error) {
			console.log(error);
		}
	}

	function getTotal() {
		total = 0;
		cartItems.forEach((cartItem) => {
			total += cartItem.itemPrice * cartItem.itemQuantity;
		});
	}

	async function removeCartItem(itemId: number) {
		try {
			const token = get(storeToken);
			const response = await fetch(`http://127.0.0.1:5182/removeCartItem/${itemId}`, {
				method: 'DELETE',
				headers: {
					Authorization: `${token}`
				}
			});
			if (response.ok) {
				loadCartItems();
				cartUpdate.update((value) => !value);
			}
		} catch (error) {
			console.log(error);
		}
	}

	async function updateCartItem(item: CartItem, qty: number) {
		try {
			item.itemQuantity = qty;
			const token = get(storeToken);
			const response = await fetch(`http://127.0.0.1:5182/updateCartItem`, {
				method: 'PUT',
				headers: {
					'content-type': 'application/json',
					Authorization: `${token}`
				},
				body: JSON.stringify(item)
			});
			if (response.ok) {
				loadCartItems();
				cartUpdate.update((value) => !value);
			}
		} catch (error) {
			console.log(error);
		}
	}

	onMount(async () => {
		loadCartItems();
	});
</script>

<div class="container">
	{#if cartItems.length > 0}
		<h2 class="mb-3 font-bold text-center">Cart</h2>
		{#each cartItems as cartItem}
			<div class="card">
				<div class="flex mt-3 px-5 py-5 gap-x-5">
					<div class="font-bold inline flex-1 self-center">{cartItem.itemName}</div>
					<div class="font-bold text-lg text-error-600 inline self-center">
						${cartItem.itemPrice}
					</div>
					<div class="inline self-center">
						<div class="btn-group variant-filled">
							<button on:click={updateCartItem(cartItem, cartItem.itemQuantity - 1)} class="btn-icon variant-filled"><Fa icon={faMinus} /> </button>
							<span class="bg-initial m-auto px-3">{cartItem.itemQuantity}</span>
							<button on:click={updateCartItem(cartItem, cartItem.itemQuantity + 1)} class="btn-icon variant-filled"><Fa icon={faPlus} /> </button>
						</div>
						<div class="btn-group variant-filled">
							<button on:click={removeCartItem(cartItem.id)} class="btn-icon variant-filled-error">
								<Fa icon={faTrash} />
							</button>
						</div>
					</div>
				</div>
			</div>
		{/each}
		<div class="total font-bold text-xl mt-3 flex">
			<span class="flex-auto">Total: ${total.toFixed(2)}</span>
			<button class="btn variant-filled" on:click={order}>
				<Fa icon={faTrash} />
				<span>Order</span>
			</button>
		</div>
	{:else}
		<div class="text-center text-xl">
			<span class="text-center">Your cart is empty.</span>
			<br />
			<a href="/">
				<button type="button" class="btn variant-filled mt-3">
					<span><Fa icon={faStore} /></span>
					<span>Shop</span>
				</button>
			</a>
		</div>
	{/if}
</div>

<style>
	.container {
		margin-left: auto;
		margin-right: auto;
		margin-top: 0.5rem;
		width: 70%;
	}
</style>
