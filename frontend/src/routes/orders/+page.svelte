<script lang="ts">
	import { goto } from '$app/navigation';
	import { storeToken, storeUsername } from '$lib/stores';
	import { onMount } from 'svelte';
	import { get } from 'svelte/store';
	import jwt_decode from 'jwt-decode';

	interface Purchase {
		id: Number;
		customer_id: Number;
		payment_id: Number;
		purchase_cost: Number;
		purchase_date: string;
	}

	interface JwtClaims {
		userId: number;
		iat: number;
		exp: number;
	}

	let orders: Purchase[] = [];

	function getUserIdFromToken(token: string): number {
		try {
			const decoded: JwtClaims = jwt_decode(token);
			return decoded.userId;
		} catch (error) {
			console.error('Error decoding token:', error);
			return -1;
		}
	}

	async function getPurchases() {
		try {
			const response = await fetch(`http://127.0.0.1:5184/getPurchasesForUser`);
			if (response.status == 200) {
				const data = await response.json();
				orders = data;
			}
		} catch (error) {
			console.log(error);
		}
	}

	onMount(async () => {
		if (get(storeToken) === null) {
			goto('/');
		} else {
			getPurchases();
		}
	});
</script>

{#if orders.length > 0}
	<div class="card">
		<div class="p-4 mt-5">
			<h2 class="font-bold mb-3">Orders</h2>
		</div>
	</div>
	{#each orders as order}
		<div class="card">
			<div class="card-header mt-5" />
			<div class="p-4 order" />
			<div class="card-footer" />
		</div>
	{/each}
{/if}

<style>
	.card {
		width: 60%;
		margin: auto;
		text-align: center;
	}
</style>
