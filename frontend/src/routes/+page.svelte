<script lang="ts">
	import Fa from 'svelte-fa/src/fa.svelte';
	import { faArrowLeft, faArrowRight, faCartPlus } from '@fortawesome/free-solid-svg-icons';
	import { cartUpdate, storeToken, storeUsername } from '$lib/stores';
	import { get } from 'svelte/store';
	import { goto } from '$app/navigation';
	import { toastStore, type ToastSettings } from '@skeletonlabs/skeleton';
	import { onMount } from 'svelte';

	let items: Item[] = [];
	let currentPage = 1;
	let totalPages = 0;

	interface CartItem {
		itemQuantity: number;
		itemId: number;
	}

	interface Item {
		id: number;
		name: string;
		description: string;
		image: string;
		price: number;
		stock: number;
	}

	async function getItems() {
		try {
			const response = await fetch(`http://127.0.0.1:5181/getItems?page=${currentPage}&size=12`);
			if (response.status == 200) {
				const data = await response.json();
				totalPages = parseInt(data.totalPages);
				items = data.data;
			}
		} catch (error) {
			console.log(error);
		}
	}

	async function addToCart(id: number) {
		if (get(storeUsername) === null) {
			const t: ToastSettings = {
				message: 'You need to be signed in to add an item to your cart.',
				background: 'variant-filled-tertiary'
			};
			toastStore.trigger(t);

			goto('/login');
		} else {
			try {
				const cartItem: CartItem = { itemId: id, itemQuantity: 1 };
				const token = get(storeToken);
				await fetch(`http://127.0.0.1:5182/addCartItem`, {
					method: 'POST',
					headers: {
						'content-type': 'application/json',
						Authorization: `${token}`
					},
					body: JSON.stringify(cartItem)
				});
				cartUpdate.update((value) => !value);

				const t: ToastSettings = {
					message: 'Item added to cart.',
					background: 'variant-filled-success'
				};
				toastStore.trigger(t);
			} catch (error) {
				console.log(error);
			}
		}
	}

	function incrementPage() {
		currentPage += 1;
		getItems();
	}

	function decrementPage() {
		currentPage -= 1;
		getItems();
	}

	onMount(async () => {
		getItems();
	});
</script>

{#if items.length > 0}
	<div class="grid grid-cols-4 gap-4">
		{#each items as item}
			<div class="card">
				<a href="item/{item.id}">
					<div class="card-header">
						<img
							class="object-scale-down w-[100px] h-[150px] mx-auto"
							src={item.image}
							alt={item.name}
						/>
					</div>
					<div class="p-4 font-bold">{item.name}</div>
				</a>
				<div class="card-footer">
					<button type="button" class="btn btn-sm variant-filled" on:click={addToCart(item.id)}>
						<span><Fa icon={faCartPlus} /></span>
						<span>Add to cart</span>
					</button>
				</div>
			</div>
		{/each}
	</div>

	<div class="text-center mt-5">
		{#if currentPage > 1}
			<button class="btn-icon variant-filled" on:click={decrementPage}>
				<Fa icon={faArrowLeft} />
			</button>
		{/if}
		<span class="bg-initial m-auto px-3 font-bold">{currentPage}</span>

		{#if currentPage + 1 <= totalPages}
			<button class="btn-icon variant-filled" on:click={incrementPage}>
				<Fa icon={faArrowRight} />
			</button>
		{/if}
	</div>
{:else}
	<div class="grid grid-cols-4 gap-4">
		{#each Array(12) as _}
			<div class="card w-full space-y-4 py-3">
				<div class="card-header w-[100px] mx-auto placeholder-circle animate-pulse" />
				<div class=" placeholder w-3/4 m-auto animate-pulse" />
				<div class="card-footer w-3/4 placeholder m-auto animate-pulse" />
			</div>
		{/each}
	</div>
{/if}

<style>
	.grid {
		text-align: center;
		margin-left: 2%;
		margin-right: 2%;
	}

	.card-header {
		margin: auto;
	}
</style>
