<script lang="ts">
	import { AppBar, toastStore, type ToastSettings, LightSwitch } from '@skeletonlabs/skeleton';

	import Fa from 'svelte-fa/src/fa.svelte';
	import { faRightToBracket, faRightFromBracket, faCartShopping } from '@fortawesome/free-solid-svg-icons';
	import { cartUpdate, storeToken, storeUsername } from './stores';
	import { get } from 'svelte/store';
	import { onDestroy } from 'svelte';
	import { goto } from '$app/navigation';

	let cartItemCount = 0;

	function logout() {
		storeUsername.set(null);
		storeToken.set(null);

		const t: ToastSettings = {
			message: 'You have been signed out.'
		};
		toastStore.trigger(t);

		goto('/');
	}

	async function getCartItemCount() {
		if (get(storeToken) !== null) {
			try {
				const token = get(storeToken);
				const response = await fetch(`http://127.0.0.1:5182/getUserItems`, {
					method: 'GET',
					headers: {
						Authorization: `${token}`
					}
				});
				if (response.ok) {
					const data = await response.json();
					cartItemCount = data.length;
				}
			} catch (error) {
				console.log(error);
			}
		}
	}

	const unsubscribe = cartUpdate.subscribe((_) => {
		getCartItemCount();
	});

	onDestroy(unsubscribe);
</script>

<div class="navigation">
	<AppBar>
		<svelte:fragment slot="lead">
			<a href="/">
				<button type="button" class="btn bg-initial hover:bg-surface-200 dark:hover:bg-surface-600">
					<span
						class="text-xl font-bold bg-gradient-to-br from-surface-500 to-surface-500 dark:from-surface-100 dark:to-surface-100 bg-clip-text text-transparent box-decoration-clone"
						>Vulnerability Shop</span
					>
				</button>
			</a>
		</svelte:fragment>
		<svelte:fragment slot="trail">
			{#if $storeUsername === null}
				<a href="/login">
					<button type="button" class="btn bg-initial hover:bg-surface-200 dark:hover:bg-surface-600">
						<span><Fa icon={faRightToBracket} /></span>
						<span>Login</span>
					</button>
				</a>
			{:else}
				<a href="/cart">
					<button type="button" class="btn-icon bg-initial hover:bg-surface-200 dark:hover:bg-surface-600 relative inline">
						<span class="badge-icon variant-soft-error absolute -top-0 -right-0 z-10">{cartItemCount} </span>
						<Fa icon={faCartShopping} />
					</button>
				</a>
				<button type="button" on:click={logout} class="btn bg-initial hover:bg-surface-200 dark:hover:bg-surface-600">
					<span><Fa icon={faRightFromBracket} /></span>
					<span>Logout</span>
				</button>
			{/if}
			<LightSwitch />
		</svelte:fragment>
	</AppBar>
</div>

<slot />

<style>
	.navigation {
		margin-bottom: 2%;
	}
</style>
