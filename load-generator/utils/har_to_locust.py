import json
import os
import sys

# converts HAR files to locust functions.
# usage:  python har_to_locust.py <path to har file>
# output: har_to_locust_out.py
# note:   POST calls maybe need to be adjusted manually afterwards.
def main():
    file = open(sys.argv[1], "r")

    data = json.load(file)
    outfile = open("har_to_locust_out.py", "w")

    for entry in data['log']['entries']:
        request = entry['request']

        method = str.lower(request['method'])
        url = request['url']

        headers = {}
        for h in request['headers']:
            headers[h['name']]=h['value']
            pass

        if 'postData' in request:
            postData = str.replace(request['postData']['text'], '"', "\\\"")
        else:
            postData = ""

        outfile.write(
            "self.client.{0}(\"{1}\", headers={2}, data=\"{3}\"){4}"
            .format(
                method,
                url, 
                headers, 
                postData, 
                os.linesep
            ))
        pass

    outfile.close()

    print('done')

if __name__ == "__main__":
    if (len(sys.argv) < 2):
        raise FileNotFoundError("HAR file not specified")
    main()