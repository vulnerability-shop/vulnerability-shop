import json
from locust import FastHttpUser
from config import config


def add_review(http: FastHttpUser, auth_token, item_id, review_text):
    url = f'{config["review"]["host"]}/postReview'
    data = {
        'itemId': 0,
        'title': item_id,
        'reviewText': review_text
    }

    with http.rest(method="POST", url=url, json=data, headers={'Authorization': auth_token}) as response:
        if response.js is not None:
            review = json.loads(response.text)['data']
            return review


# TODO implement
def add_image_to_review(http: FastHttpUser, auth_token, review_id, image_path):
    url = f'{config["review"]["host"]}/postPicture/{review_id}'
    files = {'picture': open(image_path, 'rb')}
    
    with http.rest(method="POST", url=url, data=files, headers={'Authorization': auth_token}) as response:
        if response.js is not None:
            review = json.loads(response.text)['data']
            return review


def add_review_with_image(http: FastHttpUser, auth_token, item_id, review_text, image_path):
    review = add_review(http, auth_token, item_id, review_text)
    add_image_to_review(http, auth_token, review['id'], image_path)
