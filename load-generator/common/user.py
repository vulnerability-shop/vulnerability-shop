import json
import random
import csv
from locust import FastHttpUser

def fetch_user_credentials(user_id: int = -1):
    users_migration = '../../postgresql/migrations/import_data_Customer.csv'
    with open(users_migration, newline='') as csvfile:
        csvreader = csv.reader(csvfile, delimiter=',')
        if user_id != -1:
            row = list(csvreader)[user_id]
        else:
            row = random.choice(list(csvreader))
        return row[1], row[2]


def login_with_credentials(http: FastHttpUser, username, password):
    url = 'http://127.0.0.1:5180/login'

    data = {
        'username': username,
        'password': password
    }

    with http.rest(method="POST", url=url, json=data) as response:
            if response.ok:
                auth_token = json.loads(response.text)['token']
                return auth_token
            else:
                return ''


def login_with_id(http: FastHttpUser,  user_id: int = -1):
    username, password = fetch_user_credentials(user_id)
    return login_with_credentials(http, username, password)


def random_login(http: FastHttpUser):
    username, password = fetch_user_credentials()
    return login_with_credentials(http, username, password)
