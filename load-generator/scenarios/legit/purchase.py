from common.cart import add_to_cart_random
from common.user import random_login
from locust import FastHttpUser, task, run_single_user
import config


class PurchaseScenario(FastHttpUser):

    @task
    def main(self):
        # Login
        auth = random_login(self)
        
        # Add items to cart, if for some reason none were added, stop here
        nb_items = add_to_cart_random(self, auth)
        if nb_items == 0:
            print('No items were added to the cart, aborting purchase')
            return

        # Complete purchase
        self.host = config["purchase"]["host"]
        url = '/addPurchase'

        with self.rest(method="POST", url=url, headers={'Authorization': auth}) as response:
            if response.ok:
                print(f'Normal purchase successful')
            elif response.status_code == 400:
                print('Not enough items for normal purchase')
            elif response.status_code == 401:
                print('Login error in normal purchase')
                exit(1)
            else:
                print(f'Error in normal purchase: {response.status_code}')
                exit(1)


if __name__ == '__main__':
    run_single_user(PurchaseScenario)
