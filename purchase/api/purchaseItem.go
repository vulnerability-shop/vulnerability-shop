package api

import (
	"context"
	"encoding/json"
	"net/http"

	"github.com/go-chi/render"
	"github.com/vulnerability-shop/vulnerability-shop/purchase/models"
	"github.com/vulnerability-shop/vulnerability-shop/purchase/utils"
)

func GetPurchaseItems(w http.ResponseWriter, r *http.Request) {
	var items []models.PurchaseItem

	rows, err := utils.DB.Query(context.Background(), "SELECT * FROM purchaseitem")
	if err != nil {
		w.WriteHeader(http.StatusInternalServerError)
		w.Write([]byte(err.Error()))
		return
	}

	defer rows.Close()

	for rows.Next() {
		var item models.PurchaseItem
		err = rows.Scan(&item.Id, &item.PurchaseId, &item.ItemId, &item.Quantity)
		if err != nil {
			w.WriteHeader(http.StatusInternalServerError)
			w.Write([]byte(err.Error()))
			return
		}
		items = append(items, item)
	}

	if rows.Err() != nil {
		w.WriteHeader(http.StatusInternalServerError)
		w.Write([]byte(err.Error()))
		return
	}

	render.JSON(w, r, &items)
}

func GetPurchaseItemById(w http.ResponseWriter, r *http.Request) {
	var item models.PurchaseItem

	id := r.URL.Query().Get("id")
	if id == "" {
		w.WriteHeader(http.StatusBadRequest)
		return
	}

	err := utils.DB.QueryRow(context.Background(), "SELECT * FROM purchaseitem WHERE id=$1",
		id).Scan(&item.Id, &item.PurchaseId, &item.ItemId, &item.Quantity)
	if err != nil {
		w.WriteHeader(http.StatusInternalServerError)
		w.Write([]byte(err.Error()))
		return
	}

	render.JSON(w, r, &item)
}

func GetPurchaseItemsForPurchase(w http.ResponseWriter, r *http.Request) {
	var items []models.PurchaseItem

	id := r.URL.Query().Get("id")
	if id == "" {
		w.WriteHeader(http.StatusBadRequest)
		return
	}

	rows, err := utils.DB.Query(context.Background(), "SELECT * FROM purchaseitem WHERE purchase_id=$1", id)
	if err != nil {
		w.WriteHeader(http.StatusInternalServerError)
		w.Write([]byte(err.Error()))
		return
	}

	defer rows.Close()

	for rows.Next() {
		var item models.PurchaseItem
		err = rows.Scan(&item.Id, &item.PurchaseId, &item.ItemId, &item.Quantity)
		if err != nil {
			w.WriteHeader(http.StatusInternalServerError)
			w.Write([]byte(err.Error()))
			return
		}
		items = append(items, item)
	}

	if rows.Err() != nil {
		w.WriteHeader(http.StatusInternalServerError)
		w.Write([]byte(err.Error()))
		return
	}

	render.JSON(w, r, &items)
}

func AddPurchaseItem(w http.ResponseWriter, r *http.Request) {
	var item models.PurchaseItem

	err := json.NewDecoder(r.Body).Decode(&item)
	// Validate that all the information required was sent to us
	if err != nil || item.PurchaseId == 0 || item.ItemId == 0 || item.Quantity == 0 {
		w.WriteHeader(http.StatusBadRequest)
		return
	}

	err = utils.AddPurchaseItem(item)
	if err != nil || item.PurchaseId == 0 || item.ItemId == 0 || item.Quantity == 0 {
		w.WriteHeader(http.StatusBadRequest)
		return
	}

	w.Write([]byte("PurchaseItem successfully created."))
}
